首先，我们需要了解`pipeline`（流水线）的作用。

`Jenkins`的`pipeline`是一种以脚本方式描述构建、测试和部署各个步骤的机制，用于实现持续集成和持续交付。通过`pipeline`，开发团队可以自动化地管理和监控整个软件交付流程，从而提升`CI/CD`的效率和稳定性。

`Jenkinsfile`是用于定义`pipeline`的配置文件。它没有文件后缀，推荐命名为`Jenkinsfile`。借助这个文件，开发人员可以将持续集成和持续交付的流程以代码形式纳入版本控制系统，在代码仓库中统一管理。

那么如何使用`Jenkinsfile`呢？简单来说，只需在`Jenkins`页面中配置`pipeline`，填写代码仓库地址以及`Jenkinsfile`的路径。配置保存后，每当构建被触发，`Jenkins`都会按照`Jenkinsfile`中的内容依次执行`pipeline`流程。

将`Jenkinsfile`存放在代码仓库中，是`Jenkins`官方推荐的实践，通常被称为`Pipeline as Code`（流水线即代码）。

`pipeline`有两种分类：脚本式和声明式。

### 1. 脚本式流水线

语法规则：

```groovy
node {
    stage('Build') {
        sh 'make build'
    }
    stage('Test') {
        sh 'make test'
    }
    stage('Deploy') {
        sh 'make deploy'
    }
}
```

使用基于`groovy`的脚本语法编写，具有更灵活的语法和控制结构，允许开发者使用更完整的编程语言来定义流水线。适合有编程经验的用户，以及需要高度自定义的需求。

### 2. 声明式流水线

语法规则：

```groovy
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                sh 'make build'
            }
        }
        stage('Test') {
            steps {
                sh 'make test'
            }
        }
        stage('Deploy') {
            steps {
                sh 'make deploy'
            }
        }
    }
}
```

基于声明式语法，使用更加结构化的语法（`DSL`），使得编写和维护更加直观。适合简单的流水线编写。

具体使用哪一种，要视情况而定，它们都是可以写到`Jenkinsfile`里的语法结构。

上面的`Jenkinsfile`实际上依赖于`Makefile`，每个`stage`中调用的都是`shell`命令，`make`命令会执行`Makefile`中定义的规则和目标，如果`Makefile`中未定义`test`、`deploy`等目标，这些命令在`Jenkins`构建时就会报错。`Jenkinsfile`是流水线的编排脚本，用于定义命令的执行时机和顺序，而`Makefile`是具体的构建脚本，用于定义每个构建步骤的执行方式。

在实际的`CI/CD`实践中，`Jenkinsfile`也非常常见地会依赖`Dockerfile`。`Jenkinsfile`依然只负责流水线的编排，例如镜像构建、测试、发布等阶段的执行顺序；而`Dockerfile`则负责定义构建和运行所需的基础环境，包括操作系统、运行时、依赖库以及镜像交付物形式。通过在`Jenkinsfile`中执行`docker build`，或直接将`Dockerfile`作为`pipeline agent`，可以确保流水线中的所有步骤都运行在一致且可复现的容器环境中，从而避免“本地可运行、`CI`不可运行”的问题。

在更成熟的工程结构中，`Jenkinsfile`、`Dockerfile`与`Makefile`往往会同时存在并各司其职：`Jenkinsfile`用于描述流水线流程和阶段划分，`Dockerfile`用于构建统一的运行环境和镜像交付物，而`Makefile`用于抽象出具体的构建、测试和打包命令。三者组合后，`Jenkinsfile`保持简洁，只关注流程控制；构建细节集中在`Makefile`和`Dockerfile`中，既方便本地开发复用，也提升了整个持续集成和持续交付流程的稳定性与可维护性。

更多关于`Jenkinsfile`语法相关的内容，后续会进行细致补充。
