除了`string`数据类型有`setex`可以在设置数据同时设置过期时间外，其余的数据类型都需要依靠`expire`命令设置过期时间，这个命令是针对`key`进行操作的。

### 1. 过期时间有什么用？

`Redis`将数据存储在内存中，若所有数据永久保存，容易导致内存耗尽（`OOM`）问题。

在处理具有时效性的数据（例如短信验证码有效期为`120`秒，用户登录`token`有效期为一天）时，如果将这些数据存储在`MySQL`中，通常需要额外编写逻辑来检测并删除过期数据。这不仅增加了开发的复杂性，还可能导致系统性能下降。而使用`Redis`的过期时间功能，可以自动为键设置过期时间，到期后数据会自动删除，从而简化了清理工作，提升了系统性能和资源管理效率。

### 2. 如何判断数据过期

`Redis`通过一个过期字典（可以看作是一个`hash`表）来管理数据的过期时间。这个过期字典的键是`Redis`中的某个`key`，而值是该`key`的过期时间（精确到毫秒）。在`C`语言中的源代码如下所示：

~~~ c
typedef struct redisDb {
    ...
    dict *dict;     // 数据库键空间，保存着数据库中所有键值对
    dict *expires   // 过期字典，保存着键的过期时间（毫秒）
    ...
} redisDb;
~~~

### 3. 过期数据如何删除？

当`Redis`中的数据过期了，通常有以下三种过期策略：

1. 定时过期

   每个设置过期时间的`key`都要创建一个定时器，过期时间一到，数据立即清除。这种策略对内存很友好，但是会占用大量`CPU`资源处理过期数据，影响响应时间和吞吐量。这种策略`Redis`并没有采用。

2. 惰性过期

   只有当用户访问数据时，才会判断这个数据是否已经过期，若过期则清除数据。这种策略可以节省`CPU`资源，但是对内存不友好，可能出现大量过期数据未被访问，占用大量内存的情况。

3. 定期清除

   每隔一段时间，扫描过期字典中一定数量的数据，并清除其中过期的数据。该方案可以在内存和`CPU`中达到一种平衡。同时，`Redis`底层通过限制删除操作的执行时长和频率，有效减少了删除操作对`CPU`的影响。

> `Redis`采用惰性过期+定期清除的过期策略。

