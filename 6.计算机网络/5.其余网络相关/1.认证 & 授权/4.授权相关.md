授权的核心就是回答三个问题：谁（主体），对什么资源（对象），能做什么操作（动作）。

- 主体：通常是用户、用户组、角色、服务账号等，例如用户`Alice`。
- 对象：某个接口、某张表、某个字段、某个文件，甚至是一个微服务。
- 动作：描述主体可以对资源做什么，常见的操作有读、写、删除、更新、执行等。

我们使用下方的命令引入`Casbin`授权相关第三方库：

```sh
go get github.com/casbin/casbin/v2
go get github.com/casbin/gorm-adapter/v3
```

在`Casbin`里，这个三元关系为`sub`（`subject`）、`obj`（`object`）和`act`（`action`），它们合称为策略（`policy`）。

使用`Casbin`进行权限控制，可以使用模型文件`model.conf`来定义访问控制模型。该模型文件示例如下：

```ini
[request_definition]
r = sub, obj, act

[policy_definition]
p = sub, obj, act

[role_definition]
g = _, _

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m = g(r.sub, p.sub) && r.obj == p.obj && r.act == p.act
```

上面是一个基于角色的访问控制（`RBAC`）配置，我们可通过修改`model.conf`将其调整为基于属性的访问控制（`ABAC`）等形式。

例如我们把`model.conf`文件放到`cmd/casbin`目录下，生成库表并获取`enforcer`对象的代码如下所示：

```go
func InitEnforcer() (*casbin.Enforcer, error) {
	adapter, err := gormadapter.NewAdapterByDB(db.GetDB())
	if err != nil {
		wlog.Error("call gormadapter.NewAdapterByDB failed").Err(err).Log()
		return nil, err
	}
	enforcer, err := casbin.NewEnforcer("cmd/casbin/model.conf", adapter)
	if err != nil {
		wlog.Error("call casbin.NewEnforcer failed").Err(err).Log()
		return nil, err
	}
	err = enforcer.LoadPolicy()
	if err != nil {
		wlog.Error("call enforcer.LoadPolicy failed").Err(err).Log()
		return nil, err
	}
	return enforcer, nil
}

func main() {
    err := utils.InitConfig()
	if err != nil {
		wlog.Error("call utils.InitConfig failed").Err(err).Log()
        return
	}
	enforcer, err := InitEnforcer()
	if err != nil {
		wlog.Error("init casbin enforcer failed").Err(err).Log()
        return
	}
}
```

`gormadapter.NewAdapterByDB`函数会检查指定数据库中是否存在`casbin_rule`表，如果不存在，则会自动创建：

```sql
CREATE TABLE `casbin_rule` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `ptype` VARCHAR(100) DEFAULT NULL,
  `v0` VARCHAR(100) DEFAULT NULL,
  `v1` VARCHAR(100) DEFAULT NULL,
  `v2` VARCHAR(100) DEFAULT NULL,
  `v3` VARCHAR(100) DEFAULT NULL,
  `v4` VARCHAR(100) DEFAULT NULL,
  `v5` VARCHAR(100) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_casbin_rule` (`ptype`,`v0`,`v1`,`v2`,`v3`,`v4`,`v5`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

表中的`ptype`字段表示策略类型，常见取值有两种：

- `g`表示分组策略，用于定义继承关系，例如`g, Alice, admin`，表示用户`Alice`属于用户组`admin`，也就是拥有角色`admin`。
- `p`表示策略规则，例如`p, admin, /api/user, GET`，表示角色`admin`可以对接口`/api/user`发起`GET`请求。

`v0`到`v5`是策略参数的占位字段，在`model.conf`中定义的策略字段会映射到这些字段上。例如定义`p = sub, obj, act`时，对应到表中为`v0 = sub`、`v1 = obj`、`v2 = act`；定义`g = _, _`时，第一个`_`对应`v0`，第二个`_`对应`v1`。如果策略包含更多维度，则可以依次使用`v3`、`v4`、`v5`进行存放。

所以这张`casbin_rule`表既可以存储用户-角色关系，也可以存储角色-资源权限。

待办
