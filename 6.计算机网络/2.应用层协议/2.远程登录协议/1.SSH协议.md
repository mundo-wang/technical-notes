`SSH`（`Secure Shell Protocol`，安全外壳协议）是一种运行在应用层（`Application Layer`）的协议。它提供了安全的远程登录、命令执行以及安全的数据通信传输机制。在`TCP/IP`模型中，应用层是最高层，负责处理网络服务和用户应用的网络访问，`SSH`使用`TCP`协议作为传输层协议，以确保可靠的数据传输和连接。

可以将`SSH`协议比作一扇安全的传送门，让我们能够远程进入公司的服务器，就像在本地工作站上一样操作。可以执行查看文件、修改配置、运行程序等操作，所有这些操作都是通过安全的连接进行的，确保了数据的保密性和完整性。

这样，通过`SSH`，即使我们身处异地，也可以像在服务器前亲自操作一样，进行高效、安全的远程管理。

### 端口转发

本地端口转发和远程端口转发是`SSH`协议的两种端口转发方式，用于在安全连接下将网络流量导向到其他主机服务器或端口。

> 在`SSH`连接之上启用了端口转发时，会被称为`SSH`隧道；单纯的`SSH`登录连接本身不会称为隧道。

#### 1. 本地端口转发

本地端口转发是指在本地服务器上监听一个端口，并将所有访问该端口的流量通过`SSH`隧道转发到远程服务器上的指定端口。

例如，远程服务器有一个服务运行在`8080`端口，我们希望通过`SSH`连接，在本地服务器暴露一个`8090`端口来访问它：

```bash
ssh -L 8090:localhost:8080 user@remote_ip
```

这样，当本地服务器访问`8090`端口时，实际上访问的是远程服务器上的`8080`端口。

本地端口转发的命令格式为：

```sh
ssh -L [本地端口]:[目标主机]:[目标端口] user@remote_ip
```

> 注意：这里的目标主机相对于服务部署端而言，若服务部署在远程服务器本机，则该处的`host`应该填写为`localhost`。

#### 2. 远程端口转发

远程端口转发是指在远程服务器上监听一个端口，并将所有访问该端口的流量通过`SSH`隧道转发到本地服务器上的指定端口。

例如，本地服务器上有一个服务运行在`3306`端口，我们希望通过`SSH`连接，在远程服务器暴露一个`3307`端口来访问它：

```bash
ssh -R 3307:localhost:3306 user@remote_ip
```

这样，当远程服务器访问`3307`端口时，实际上访问的是本地服务器上的`3306`端口。

远程端口转发的命令格式为：

```sh
ssh -R [远程端口]:[目标主机]:[目标端口] user@remote_ip
```

> 注意：这里的目标主机相对于服务部署端而言，如果服务部署在本地服务器本机，则该处的`host`应该填写为`localhost`。

无论是本地端口转发还是远程端口转发，这里的`user@remote_ip`均表示远程服务器的用户名与`IP`地址信息。

我们可以这样记忆这两种服务转发：

- 本地端口转发（`-L`）：本地负责监听，远程负责服务。

- 远程端口转发（`-R`）：远程负责监听，本地负责服务。

在实际执行命令时，通常会搭配`-fN`一起使用。其中，`-f`表示在认证成功后让`ssh`进入后台运行，适用于只需要建立端口转发或隧道、不需要打开交互式终端的场景；`-N`表示不执行任何远程命令，仅用于端口转发或隧道，不在远程主机上运行命令。两者配合使用，表示`SSH`仅建立隧道而不打开`shell`。

#### 3. 动态端口转发

动态端口转发会在本地创建一个`SOCKS`代理端口，无需事先指定目标服务器的`IP`与端口。所有符合`SOCKS`协议的流量，都会通过已建立的`SSH`连接，根据请求中携带的目标地址进行动态转发。

动态端口转发的命令如下所示：

```sh
ssh -D [本地端口] user@remote_ip
```

这里的`local_port`监听在本地机器上，用于提供`SOCKS`代理服务；`remote_ip`表示`SSH`连接的对端，即跳板机，作为实际的网络出口。所有真实的目标连接均由跳板机发起并完成，随后再通过隧道转发回本地的指定端口。
