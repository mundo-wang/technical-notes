钉钉企业内部微应用免登接入系统平台，其`plantUML`代码如下所示：

```scss
@startuml
actor 前端
participant 钉钉服务
participant 后端
database ding_talk_app_config as Config表
database ding_talk_app_user as 钉钉User表
database sys_user as 系统User表

前端 -> 钉钉服务 : 调用接口，传入corpId、clientID，获取authCode
钉钉服务 --> 前端 : 返回authCode（过期时间非常短，使用一次后无效）
前端 -> 后端 : 提交authCode、corpId、agentId（确定企业下的唯一应用）

后端 -> Config表 : 根据corpId、agentId查询应用信息
Config表 --> 后端 : 返回ak、sk

后端 -> 钉钉服务 : 使用ak、sk获取accessToken（这里省略accessToken的存储）
钉钉服务 --> 后端 : 返回accessToken

后端 -> 钉钉服务 : 使用authCode、accessToken获取用户信息
钉钉服务 --> 后端 : 返回dingUserId等信息

后端 -> 钉钉User表 : 使用dingUserId与ding_talk_app_config主键ID，查询该用户是否登录过该应用
alt 已登录
    钉钉User表 --> 后端 : 返回用户记录
else 未登录
    后端 -> 钉钉服务 : 使用dingUserId、accessToken获取用户详细信息
    钉钉服务 --> 后端 : 返回手机号、用户名等
    后端 -> 系统User表 : 根据手机号查询平台用户
    alt 已匹配到用户
        系统User表 --> 后端 : 返回平台用户记录
        后端 -> 钉钉User表 : 新增钉钉用户记录
    else 未匹配到用户
        系统User表 --> 后端 : 返回无匹配平台用户信息
        后端 --> 前端 : 返回错误信息，提示用户需要先在平台注册登录
    end
end

后端 -> 后端 : 生成系统token
后端 -> 前端 : 返回系统token
@enduml
```

获取到`token`后，再次进行登录时的校验流程，其`plantUML`语法如下所示：

```scss
@startuml
actor 前端
participant 鉴权组件
database Redis as Token缓存
database ding_talk_app_user as 钉钉User表
participant 后端服务

前端 -> 鉴权组件 : 请求该应用下其他接口，携带系统token

alt token为空
    鉴权组件 --> 前端 : 返回错误信息，提示重新登录
else token不为空
    鉴权组件 -> Token缓存 : 根据token查询用户信息
    alt token存在且未过期
        Token缓存 --> 鉴权组件 : 返回钉钉用户ID、ding_talk_app_config表主键ID
        鉴权组件 -> 钉钉User表 : 根据钉钉用户ID、ding_talk_app_config表主键ID，查询该用户是否登录过该应用
        钉钉User表 --> 鉴权组件 : 查询到记录，返回用户信息
        鉴权组件 -> 后端服务 : 校验通过，执行业务逻辑（这里省略获取accessToken步骤）
        后端服务 --> 前端 : 返回业务结果
    else token不存在或已过期
        Token缓存 --> 鉴权组件 : 没有查询到该token
        鉴权组件 --> 前端 : 返回错误信息，提示重新登录
    end
end
@enduml
```

